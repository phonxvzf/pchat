<!DOCTYPE html>
<style>
h1 {
  background: #fcccff;
}
h2 {
  background: #ccdfff;
}
#chatBoard {
  width: 80%;
  height: 400px;
  border-style: solid;
  border-width: medium;
  overflow: scroll;
}
.msgOwn {
  background: #f4ffba;
  color: #000;
}
.msgOther {
  background: #fff;
  color: #000;
}
.longInput {
  width: 40%;
}
</style>
<html>
  <head>
    <meta charset="UTF-8">
    <title>pchat</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.slim.js"></script> 
  </head>
  <body>
    <h1>Welcome to pchat!</h1>
    <div>
      <h2>Register</h2>
    </div>
    <hr>
    <div>
      <h2>Login</h2>
    </div>
    <hr>
    <div>
      <h2>You</h2>
      <h3>Profile</h3>
      <h3>Groups</h3>
    </div>
    <hr>
    <div>
      <h2>Chat</h2>
      Current group: <span id="currentGroup">-</span><br>
      <div>
        <form id="joinForm">
          <input type="text" class="longInput" id="userId" placeholder="userId" autocomplete="off"></input><br>
          <input type="text" class="longInput" id="groupId" placeholder="groupId" autocomplete="off"></input><br>
          <input type="submit" value="join"></input>
        </form>
        <button id="btnLeave">leave room</button>
      </div>
      <hr>
      <div id="chatBoard"></div>
      <div>
        <form id="chatForm">
          <input type="text" class="longInput" id="chatMessage" placeholder="message" autocomplete="off"></input>
          <input type="submit" value="send"></input>
        </form>
      </div>
      <br>
      Error message: <span id="errorMessage">none</span>
    </div>
  </body>
  <script>
    var currentGroup = null;
    var clientUserId = null;
    var clientGroupId = null;
    const myMessageIds = new Set();
    const messageIds = {};

    function appendMessages(messages) {
      let lastMessageId = null;
      for (let i = 0; i < messages.length; ++i) {
        const m = messages[i];
        if (messageIds[currentGroup].has(m.messageId)) continue;
        const cl = myMessageIds.has(m.messageId) ? 'msgOwn' : 'msgOther';
        const datetime = new Date(m.time);
        const dateString = datetime.toDateString() + ' ' + datetime.toTimeString().substr(0,8);
        $('#chatBoard').append($('<div/>')
          .attr('class', cl)
          .text(dateString + ' [' + m.senderName + ']: ' + m.text));
        lastMessageId = m.messageId;
        messageIds[currentGroup].add(m.messageId);
      }
      const chatBoard = document.getElementById("chatBoard");
      chatBoard.scrollTop = chatBoard.scrollHeight;
      return lastMessageId;
    }

    window.onload = () => {
      const sio = io();

      // on form submit
      $('#joinForm').submit((e) => {
        e.preventDefault();
        const userId = $('#userId').val();
        const groupId = $('#groupId').val();
        if (userId == '' || groupId == '') return false;
        sio.emit('join', groupId);
        clientUserId = userId;
        clientGroupId = groupId;
        return false;
      });

      $('#btnLeave').click(() => {
        sio.emit('leave', clientGroupId);
      });

      sio.on('leaveACK', () => {
        $("#chatBoard").empty();
        clientGroupId = null;
      });

      sio.on('errorMessage', (msg) => {
        $('#errorMessage').text(msg);
      });

      sio.on('joinACK', (msg) => {
        $('#currentGroup').text(msg.groupName);
        currentGroup = msg.groupId;
        if (messageIds[currentGroup] == null) {
          messageIds[currentGroup] = new Set();
          appendMessages(msg.messages);
          msg.messages.forEach(m => messageIds[currentGroup].add(m.messageId));
        }

        $('#chatForm').submit((e) => {
          if (clientUserId == null || clientGroupId == null) return false;
          if (clientUserId == '' || clientGroupId == '') return false;
          e.preventDefault();
          const msg = $('#chatMessage').val();
          const id = window.crypto
            .getRandomValues(new Uint32Array(1))[0]
            .toString(16);
          myMessageIds.add(id);
          if (msg.length > 0) {
            sio.emit('message', {
              userId: clientUserId,
              text: msg,
              messageId: id,
              groupId: clientGroupId,
              senderName: 'phon'
            });
            $('#chatMessage').val('');
          }
          return false;
        });
      });

      sio.on('leaveACK', (groupId) => {
        messageIds[groupId] = null;
      });

      sio.on('newMessage', (msg) => {
        sio.emit('getUnread', {
          userId: clientUserId,
          groupId: clientGroupId,
        })
      });

      sio.on('unreadMessage', (msg) => {
        let lastMessageId = appendMessages(msg.unread);
        if (lastMessageId != null) {
          sio.emit('unreadMessageACK', {
            userId: clientUserId,
            groupId: clientGroupId,
            messageId: lastMessageId,
          });
        }
      });

      sio.on('reconnect', () => {
        if (currentGroup != null) {
          sio.emit('join', currentGroup);
        }
      });
    };
  </script>
</html>
